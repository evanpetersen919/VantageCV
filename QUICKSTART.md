# VantageCV Test Randomization - Quick Start

## Prerequisites

1. **UE5 Running** with level loaded (`/Game/automobileV2`)
2. **Remote Control API** enabled on port `30010`
3. **Locations 1-3** configured with anchors (0.3 scale zone anchors, prop anchors)

## Setup Steps (First Time Only)

### 1. Detect Zone Anchors
Run the zone detection script to classify anchors into parking/lanes/sidewalks:

```powershell
$env:PYTHONPATH="f:\vscode\VantageCV"
python scripts\capture_zones.py
```

**Output**: Detects all zone anchors (scale 0.3) across 7 locations and classifies them.

Expected for locations 1-3:
- Location 1: 5 parking, 4 lanes, 1 sidewalk
- Location 2: 6 parking, 2 lanes, 2 sidewalks  
- Location 3: 8 parking, 2 lanes, 0 sidewalks

### 2. Detect Prop Anchors (Optional)
Run the prop detection script to see available prop anchors:

```powershell
$env:PYTHONPATH="f:\vscode\VantageCV"
python scripts\capture_props.py
```

**Output**: Shows barrier/vegetation/sign/furniture/roadtrash anchors per location.

### 3. Configure Active Locations
The test script is already configured for locations 1-3:

```python
# scripts/test_randomization.py
ACTIVE_LOCATIONS = [1, 2, 3]  # Only use locations 1-3
```

To use all 7 locations later, set:
```python
ACTIVE_LOCATIONS = None  # Use all locations
```

## Running the Test

### Basic Test (20 Captures)
```powershell
$env:PYTHONPATH="f:\vscode\VantageCV"
python scripts\test_randomization.py
```

**What it does**:
1. Detects prop anchors → filters to locations 1-3
2. Detects vehicle zones (from anchor config)
3. For each of 20 iterations:
   - Randomizes time-of-day (sun rotation)
   - Randomizes weather (fog/rain)
   - Spawns 3-5 vehicles based on zone constraints:
     - Bikes → parking OR sidewalks
     - Motorcycles → parking only
     - Buses → lanes only
     - Cars → parking OR lanes
     - Trucks → parking OR lanes
   - Spawns props at anchor points (20% chance per anchor)
   - Captures image to `output/randomization_test/frame_XXX.png`
   - Resets scene to baseline

**Output**: 20 PNG images with randomized vehicles, props, time, and weather

## Location-Scoped Detection

Both zone and prop detection are now **location-aware**:

### Location Boundaries (Y-axis)
```
Location 1: Y ∈ [400,    20000 ]  (19600 units)
Location 2: Y ∈ [20000,  39600 ]  (19600 units)
Location 3: Y ∈ [39600,  59200 ]  (19600 units)
Location 4: Y ∈ [59200,  78800 ]  (19600 units)
Location 5: Y ∈ [78800,  98400 ]  (19600 units)
Location 6: Y ∈ [98400,  118000]  (19600 units)
Location 7: Y ∈ [118000, 137600]  (19600 units)
```

### Global X Bounds
Both systems only use anchors where:
```
X ∈ [5000, 30000]
```

Anchors outside this range (like prop pool at X < 0) are ignored.

## Troubleshooting

### "Found 0 anchors"
- UE5 Remote Control API not running
- Check UE5 is running with level loaded
- Verify port 30010 is accessible: `Test-NetConnection 127.0.0.1 -Port 30010`

### "No parking anchors configured"
- Run `scripts/capture_zones.py` first to detect zones
- Ensure `configs/levels/automobileV2_anchors.yaml` exists
- Vehicle spawner reads from this config file

### Import errors
- Always set PYTHONPATH before running:
  ```powershell
  $env:PYTHONPATH="f:\vscode\VantageCV"
  ```

### Wrong location counts
- Zone detection uses strict thresholds (dot=0.95 for lanes)
- Sidewalks require directional validation (arrows point toward each other)
- Parking checks for empty space (not pointing at other anchors)

## File Structure

```
scripts/
  capture_zones.py      # Detect & classify zone anchors (parking/lanes/sidewalks)
  capture_props.py      # Detect prop anchors (barrier/vegetation/sign/furniture/roadtrash)
  test_randomization.py # Main test: spawn vehicles/props, randomize environment, capture

configs/
  levels/
    automobileV2_anchors.yaml  # Generated by capture_zones.py
  vehicles.yaml                 # Vehicle pool configuration

output/
  randomization_test/
    frame_000.png
    frame_001.png
    ...
```

## Next Steps

1. ✅ Run `capture_zones.py` to detect zones
2. ✅ Run `capture_props.py` to verify props
3. ✅ Run `test_randomization.py` for 20-image test
4. Review output images in `output/randomization_test/`
5. Adjust `ACTIVE_LOCATIONS` as more locations are ready

## Notes

- **Location filtering** only applies to prop anchors (automatically filtered)
- **Vehicle zones** require manual anchor configuration in YAML
- **Backward compatibility** maintained - global view still works
- **Cleanup guaranteed** - all spawns reset after test, even on error
